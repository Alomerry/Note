<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>？ | Alomerry Note</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.107edffb.css" as="style"><link rel="preload" href="/assets/js/app.b7ea3b73.js" as="script"><link rel="preload" href="/assets/js/2.6b359cc1.js" as="script"><link rel="preload" href="/assets/js/21.c8782d58.js" as="script"><link rel="prefetch" href="/assets/js/10.787d2a20.js"><link rel="prefetch" href="/assets/js/11.3086a2de.js"><link rel="prefetch" href="/assets/js/12.35564ea2.js"><link rel="prefetch" href="/assets/js/13.2f123b38.js"><link rel="prefetch" href="/assets/js/14.3525c679.js"><link rel="prefetch" href="/assets/js/15.4722bbe8.js"><link rel="prefetch" href="/assets/js/16.8edffb72.js"><link rel="prefetch" href="/assets/js/17.fdabfd83.js"><link rel="prefetch" href="/assets/js/18.b65c102b.js"><link rel="prefetch" href="/assets/js/19.b011b776.js"><link rel="prefetch" href="/assets/js/20.279d138a.js"><link rel="prefetch" href="/assets/js/22.fcdb92d9.js"><link rel="prefetch" href="/assets/js/23.99babfc2.js"><link rel="prefetch" href="/assets/js/24.0ecb6b39.js"><link rel="prefetch" href="/assets/js/25.3c46f1d8.js"><link rel="prefetch" href="/assets/js/26.fdf72b95.js"><link rel="prefetch" href="/assets/js/27.92461dfb.js"><link rel="prefetch" href="/assets/js/3.92631181.js"><link rel="prefetch" href="/assets/js/4.4cedf91f.js"><link rel="prefetch" href="/assets/js/5.2b16318d.js"><link rel="prefetch" href="/assets/js/6.52b733f1.js"><link rel="prefetch" href="/assets/js/7.f8532b93.js"><link rel="prefetch" href="/assets/js/8.7034377b.js"><link rel="prefetch" href="/assets/js/9.8e1553d1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.107edffb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Alomerry Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="http://alomerry.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="http://alomerry.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>书籍笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法解析</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>语言心得</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文档工具</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/doc/spring.html" class="sidebar-link">Spring</a></li><li><a href="/doc/docker.html" class="sidebar-link">docker</a></li><li><a href="/doc/git.html" class="sidebar-link">Git 常用命令</a></li><li><a href="/doc/qmgo.html" class="sidebar-link">Qmgo</a></li><li><a href="/doc/redis.html" class="sidebar-link">Redis</a></li><li><a href="/doc/grpc.html" aria-current="page" class="active sidebar-link">？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/grpc.html#" class="sidebar-link">？</a></li><li class="sidebar-sub-header"><a href="/doc/grpc.html#_1-26" class="sidebar-link">1.26</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/grpc.html#grpc服务注册发现及负载均衡的实现方案与源码解析" class="sidebar-link">gRPC服务注册发现及负载均衡的实现方案与源码解析</a></li><li class="sidebar-sub-header"><a href="/doc/grpc.html#roundrobin" class="sidebar-link">RoundRobin</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/grpc.html#_1-35" class="sidebar-link">1.35</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/grpc.html#基于-grpc-的服务注册与发现和负载均衡的原理与实战" class="sidebar-link">基于 gRPC 的服务注册与发现和负载均衡的原理与实战</a></li><li class="sidebar-sub-header"><a href="/doc/grpc.html#resolver" class="sidebar-link">resolver</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id=""><a href="#" class="header-anchor">#</a> ？</h2> <p><a href="http://www.likecs.com/show-124458.html" target="_blank" rel="noopener noreferrer">http://www.likecs.com/show-124458.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_1-26"><a href="#_1-26" class="header-anchor">#</a> 1.26</h2> <h3 id="grpc服务注册发现及负载均衡的实现方案与源码解析"><a href="#grpc服务注册发现及负载均衡的实现方案与源码解析" class="header-anchor">#</a> gRPC服务注册发现及负载均衡的实现方案与源码解析</h3> <p><a href="https://blog.csdn.net/kevin_tech/article/details/109281835" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/kevin_tech/article/details/109281835<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="roundrobin"><a href="#roundrobin" class="header-anchor">#</a> RoundRobin</h3> <p>grpc client端创建连接时可以用WithBalancer来指定负载均衡组件，这里研究下grpc自带的RoundRobin（轮询调度）的实现。<a href="http://xn--google-200kj06ms0r.golang.org/grpc/balancer.go%E4%B8%AD%E3%80%82" target="_blank" rel="noopener noreferrer">源码在google.golang.org/grpc/balancer.go中。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>roundRobin结构体定义如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>type roundRobin struct {
	r      naming.Resolver
	w      naming.Watcher
	addrs  []*addrInfo
	mu     sync.Mutex
	addrCh chan []Address
	next   int
	waitCh chan struct{}
	done   bool
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>r是命名解析器，可以定义自己的命名解析器，如etcd命名解析器。如果r为nil，那么Dial中参数target将直接作为可请求地址添加到addrs中。</li> <li>w是命名解析器Resolve方法返回的watcher，该watcher可以监听命名解析器发来的地址信息变化，通知roundRobin对addrs中的地址进行动态的增删。</li> <li>addrs是从命名解析器获取地址信息数组，数组中每个地址不仅有地址信息，还有grpc与该地址是否已经创建了ready状态的连接。</li> <li>addrCh是地址数组的channel，该channel会在每次命名解析器发来地址信息变化后，将所有addrs通知到grpc内部的lbWatcher，lbWatcher是统一管理地址连接状态的协程，负责新地址的连接与被删除地址的关闭操作。</li> <li>next是roundRobin的Index，即轮询调度遍历到addrs数组中的哪个位置了。</li> <li>waitCh是当addrs中地址为空时，grpc调用Get()方法希望获取到一个到target的连接，如果设置了grpc的failfast为false，那么Get()方法会阻塞在此channel上，直到有ready的连接。</li></ul> <h4 id="roundrobin启动"><a href="#roundrobin启动" class="header-anchor">#</a> roundRobin启动</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rr <span class="token operator">*</span>roundRobin<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>target <span class="token builtin">string</span><span class="token punctuation">,</span> config BalancerConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> rr<span class="token punctuation">.</span>done <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrClientConnClosing
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rr<span class="token punctuation">.</span>r <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 如果没有解析器，那么直接将target加入addrs地址数组</span>
		rr<span class="token punctuation">.</span>addrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrInfo<span class="token punctuation">{</span>addr<span class="token punctuation">:</span> Address<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> target<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Resolve接口会返回一个watcher，watcher可以监听解析器的地址变化</span>
	w<span class="token punctuation">,</span> err <span class="token operator">:=</span> rr<span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	rr<span class="token punctuation">.</span>w <span class="token operator">=</span> w
	<span class="token comment">// 创建一个channel，当watcher监听到地址变化时，通知grpc内部lbWatcher去连接该地址</span>
	rr<span class="token punctuation">.</span>addrCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Address<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">// go 出去监听watcher，监听地址变化。</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> rr<span class="token punctuation">.</span><span class="token function">watchAddrUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="监听命名解析器的地址变化"><a href="#监听命名解析器的地址变化" class="header-anchor">#</a> 监听命名解析器的地址变化：</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rr <span class="token operator">*</span>roundRobin<span class="token punctuation">)</span> <span class="token function">watchAddrUpdates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// watcher的next方法会阻塞，直至有地址变化信息过来，updates即为变化信息</span>
	updates<span class="token punctuation">,</span> err <span class="token operator">:=</span> rr<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// 对于addrs地址数组的操作，显然是要加锁的，因为有多个goroutine在同时操作</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> update <span class="token operator">:=</span> <span class="token keyword">range</span> updates <span class="token punctuation">{</span>
		addr <span class="token operator">:=</span> Address<span class="token punctuation">{</span>
			Addr<span class="token punctuation">:</span>     update<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
			Metadata<span class="token punctuation">:</span> update<span class="token punctuation">.</span>Metadata<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> update<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
		<span class="token keyword">case</span> naming<span class="token punctuation">.</span>Add<span class="token punctuation">:</span>
		<span class="token comment">//对于新增类型的地址，注意这里不会重复添加。</span>
			<span class="token keyword">var</span> exist <span class="token builtin">bool</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> rr<span class="token punctuation">.</span>addrs <span class="token punctuation">{</span>
				<span class="token keyword">if</span> addr <span class="token operator">==</span> v<span class="token punctuation">.</span>addr <span class="token punctuation">{</span>
					exist <span class="token operator">=</span> <span class="token boolean">true</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> exist <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			rr<span class="token punctuation">.</span>addrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addrInfo<span class="token punctuation">{</span>addr<span class="token punctuation">:</span> addr<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> naming<span class="token punctuation">.</span>Delete<span class="token punctuation">:</span>
		<span class="token comment">//对于删除的地址，直接在addrs中删除就行了</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> rr<span class="token punctuation">.</span>addrs <span class="token punctuation">{</span>
				<span class="token keyword">if</span> addr <span class="token operator">==</span> v<span class="token punctuation">.</span>addr <span class="token punctuation">{</span>
					<span class="token function">copy</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
					rr<span class="token punctuation">.</span>addrs <span class="token operator">=</span> rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			grpclog<span class="token punctuation">.</span><span class="token function">Errorln</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown update.Op &quot;</span><span class="token punctuation">,</span> update<span class="token punctuation">.</span>Op<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 这里复制了整个addrs地址数组，然后丢到addrCh channel中通知grpc内部lbWatcher，</span>
	<span class="token comment">// lbWatcher会关闭删除的地址，连接新增的地址。</span>
	<span class="token comment">// 连接ready后会有专门的goroutine调用Up方法修改addrs中地址的状态。</span>
	open <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Address<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> rr<span class="token punctuation">.</span>addrs <span class="token punctuation">{</span>
		open<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>addr
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> rr<span class="token punctuation">.</span>done <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrClientConnClosing
	<span class="token punctuation">}</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rr<span class="token punctuation">.</span>addrCh<span class="token punctuation">:</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token punctuation">}</span>
	rr<span class="token punctuation">.</span>addrCh <span class="token operator">&lt;-</span> open
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h4 id="up方法"><a href="#up方法" class="header-anchor">#</a> Up方法：</h4> <p>up方法是grpc内部负载均衡watcher调用的，该watcher会读全局的连接状态改变队列，如果是ready状态的连接，会调用up方法来改变addrs地址数组中该地址的状态为<strong>已连接</strong>。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rr <span class="token operator">*</span>roundRobin<span class="token punctuation">)</span> <span class="token function">Up</span><span class="token punctuation">(</span>addr Address<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> cnt <span class="token builtin">int</span>
	<span class="token comment">//将地址数组中的addr置为已连接状态，这样这个地址就可以被client使用了。</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> rr<span class="token punctuation">.</span>addrs <span class="token punctuation">{</span>
		<span class="token keyword">if</span> a<span class="token punctuation">.</span>addr <span class="token operator">==</span> addr <span class="token punctuation">{</span>
			<span class="token keyword">if</span> a<span class="token punctuation">.</span>connected <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			a<span class="token punctuation">.</span>connected <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> a<span class="token punctuation">.</span>connected <span class="token punctuation">{</span>
			cnt<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 当有一个可用地址时，之前可能是0个，可能要很多client阻塞在获取连接地址上，这里通知所有的client有可用连接啦。</span>
	<span class="token comment">// 为什么只等于1时通知？因为可用地址数量&gt;1时，client是不会阻塞的。</span>
	<span class="token keyword">if</span> cnt <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> rr<span class="token punctuation">.</span>waitCh <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">close</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>waitCh<span class="token punctuation">)</span>
		rr<span class="token punctuation">.</span>waitCh <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//返回禁用该地址的方法</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		rr<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h4 id="down方法"><a href="#down方法" class="header-anchor">#</a> down方法：</h4> <p>down方法就简单了, 直接找到addr置为不可用就行了。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//如果addr1已经被连接上了，但是resolver通知删除了，grpc内部如何处理关闭的逻辑？</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>rr <span class="token operator">*</span>roundRobin<span class="token punctuation">)</span> <span class="token function">down</span><span class="token punctuation">(</span>addr Address<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> rr<span class="token punctuation">.</span>addrs <span class="token punctuation">{</span>
		<span class="token keyword">if</span> addr <span class="token operator">==</span> a<span class="token punctuation">.</span>addr <span class="token punctuation">{</span>
			a<span class="token punctuation">.</span>connected <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="get-方法"><a href="#get-方法" class="header-anchor">#</a> Get()方法：</h4> <p>client 需要获取一个可用的地址，如果addrs为空，或者addrs不为空，但是地址都不可用（没连接），Get()方法会返回错误。但是如果设置了failfast = false，Get()方法会阻塞在waitCh channel上，直至Up方法给到通知，然后轮询调度可用的地址。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rr <span class="token operator">*</span>roundRobin<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts BalancerGetOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>addr Address<span class="token punctuation">,</span> put <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ch <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> rr<span class="token punctuation">.</span>done <span class="token punctuation">{</span>
		rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		err <span class="token operator">=</span> ErrClientConnClosing
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// addrs的长度可能变化，如果next值超出了，就置为0，从头开始调度。</span>
		<span class="token keyword">if</span> rr<span class="token punctuation">.</span>next <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			rr<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		next <span class="token operator">:=</span> rr<span class="token punctuation">.</span>next
		<span class="token comment">//遍历整个addrs数组，直到选出一个可用的地址</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span>next<span class="token punctuation">]</span>
			<span class="token comment">// next值加一，当然是循环的，到len(addrs)后，变为0</span>
			next <span class="token operator">=</span> <span class="token punctuation">(</span>next <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span>
			<span class="token keyword">if</span> a<span class="token punctuation">.</span>connected <span class="token punctuation">{</span>
				addr <span class="token operator">=</span> a<span class="token punctuation">.</span>addr
				rr<span class="token punctuation">.</span>next <span class="token operator">=</span> next
				rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> next <span class="token operator">==</span> rr<span class="token punctuation">.</span>next <span class="token punctuation">{</span>
				<span class="token comment">// 遍历完一圈了，还没找到，走下面逻辑</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>opts<span class="token punctuation">.</span>BlockingWait <span class="token punctuation">{</span> <span class="token comment">//如果是非阻塞模式，如果没有可用地址，那么报错</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			err <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unavailable<span class="token punctuation">,</span> <span class="token string">&quot;there is no address available&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Returns the next addr on rr.addrs for failfast RPCs.</span>
		addr <span class="token operator">=</span> rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span>rr<span class="token punctuation">.</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span>addr
		rr<span class="token punctuation">.</span>next<span class="token operator">++</span>
		rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Wait on rr.waitCh for non-failfast RPCs.</span>
	<span class="token comment">// 如果是阻塞模式，那么需要阻塞在waitCh上，直到Up方法给通知</span>
	<span class="token keyword">if</span> rr<span class="token punctuation">.</span>waitCh <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		rr<span class="token punctuation">.</span>waitCh <span class="token operator">=</span> ch
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		ch <span class="token operator">=</span> rr<span class="token punctuation">.</span>waitCh
	<span class="token punctuation">}</span>
	rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			err <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
			rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> rr<span class="token punctuation">.</span>done <span class="token punctuation">{</span>
				rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				err <span class="token operator">=</span> ErrClientConnClosing
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> rr<span class="token punctuation">.</span>next <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					rr<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">0</span>
				<span class="token punctuation">}</span>
				next <span class="token operator">:=</span> rr<span class="token punctuation">.</span>next
				<span class="token keyword">for</span> <span class="token punctuation">{</span>
					a <span class="token operator">:=</span> rr<span class="token punctuation">.</span>addrs<span class="token punctuation">[</span>next<span class="token punctuation">]</span>
					next <span class="token operator">=</span> <span class="token punctuation">(</span>next <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>rr<span class="token punctuation">.</span>addrs<span class="token punctuation">)</span>
					<span class="token keyword">if</span> a<span class="token punctuation">.</span>connected <span class="token punctuation">{</span>
						addr <span class="token operator">=</span> a<span class="token punctuation">.</span>addr
						rr<span class="token punctuation">.</span>next <span class="token operator">=</span> next
						rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token keyword">return</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">if</span> next <span class="token operator">==</span> rr<span class="token punctuation">.</span>next <span class="token punctuation">{</span>
						<span class="token comment">// 遍历完一圈了，还没找到，可能刚Up的地址被down掉了，重新等待。</span>
						<span class="token keyword">break</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// The newly added addr got removed by Down() again.</span>
			<span class="token keyword">if</span> rr<span class="token punctuation">.</span>waitCh <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
				rr<span class="token punctuation">.</span>waitCh <span class="token operator">=</span> ch
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				ch <span class="token operator">=</span> rr<span class="token punctuation">.</span>waitCh
			<span class="token punctuation">}</span>
			rr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><h4 id="lbwatcher"><a href="#lbwatcher" class="header-anchor">#</a> lbWatcher：</h4> <p>lbWatcher会监听地址变化信息，roundroubin每次有地址变化时，会将所有的地址通知给lbWatcher，lbWatcher本身维护了地址连接的map表，会找出新添加的地址和需要删除的地址，然后做连接、关闭操作，再调用roundRobin的Up/Down方法通知连接的状态。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>bw <span class="token operator">*</span>balancerWrapper<span class="token punctuation">)</span> <span class="token function">lbWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	notifyCh <span class="token operator">:=</span> bw<span class="token punctuation">.</span>balancer<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> notifyCh <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 没有定义解析器，直接连接这个地址。</span>
		a <span class="token operator">:=</span> resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>
			Addr<span class="token punctuation">:</span> bw<span class="token punctuation">.</span>targetAddr<span class="token punctuation">,</span>
			Type<span class="token punctuation">:</span> resolver<span class="token punctuation">.</span>Backend<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		sc<span class="token punctuation">,</span> err <span class="token operator">:=</span> bw<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">NewSubConn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>a<span class="token punctuation">}</span><span class="token punctuation">,</span> balancer<span class="token punctuation">.</span>NewSubConnOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			grpclog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;Error creating connection to %v. Err: %v&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			bw<span class="token punctuation">.</span>conns<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> sc
			bw<span class="token punctuation">.</span>connSt<span class="token punctuation">[</span>sc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>scState<span class="token punctuation">{</span>
				addr<span class="token punctuation">:</span> Address<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> bw<span class="token punctuation">.</span>targetAddr<span class="token punctuation">}</span><span class="token punctuation">,</span>
				s<span class="token punctuation">:</span>    connectivity<span class="token punctuation">.</span>Idle<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
			bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			sc<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> addrs <span class="token operator">:=</span> <span class="token keyword">range</span> notifyCh <span class="token punctuation">{</span>
			<span class="token keyword">var</span> newAddrs <span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> addrs <span class="token punctuation">{</span>
				newAddr <span class="token operator">:=</span> resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>
					Addr<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
					Type<span class="token punctuation">:</span>       resolver<span class="token punctuation">.</span>Backend<span class="token punctuation">,</span> <span class="token comment">// All addresses from balancer are all backends.</span>
					ServerName<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
					Metadata<span class="token punctuation">:</span>   a<span class="token punctuation">.</span>Metadata<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				newAddrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newAddrs<span class="token punctuation">,</span> newAddr<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">var</span> <span class="token punctuation">(</span>
				add <span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address <span class="token comment">// Addresses need to setup connections.</span>
				del <span class="token punctuation">[</span><span class="token punctuation">]</span>balancer<span class="token punctuation">.</span>SubConn <span class="token comment">// Connections need to tear down.</span>
			<span class="token punctuation">)</span>
			resAddrs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>Address<span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> addrs <span class="token punctuation">{</span>
				resAddrs<span class="token punctuation">[</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>
					Addr<span class="token punctuation">:</span>       a<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span>
					Type<span class="token punctuation">:</span>       resolver<span class="token punctuation">.</span>Backend<span class="token punctuation">,</span> <span class="token comment">// All addresses from balancer are all backends.</span>
					ServerName<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
					Metadata<span class="token punctuation">:</span>   a<span class="token punctuation">.</span>Metadata<span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span> a
			<span class="token punctuation">}</span>
			bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// 新添加的地址，需要去新建连接</span>
			<span class="token keyword">for</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> resAddrs <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> bw<span class="token punctuation">.</span>conns<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
					add <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 要被删除的地址，需要去关闭连接</span>
			<span class="token keyword">for</span> a<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> bw<span class="token punctuation">.</span>conns <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> resAddrs<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
					del <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>del<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
					<span class="token function">delete</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span>conns<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
					<span class="token comment">// Keep the state of this sc in bw.connSt until its state becomes Shutdown.</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> a <span class="token operator">:=</span> <span class="token keyword">range</span> add <span class="token punctuation">{</span>
				sc<span class="token punctuation">,</span> err <span class="token operator">:=</span> bw<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">NewSubConn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>a<span class="token punctuation">}</span><span class="token punctuation">,</span> balancer<span class="token punctuation">.</span>NewSubConnOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					grpclog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;Error creating connection to %v. Err: %v&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					bw<span class="token punctuation">.</span>conns<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> sc
					bw<span class="token punctuation">.</span>connSt<span class="token punctuation">[</span>sc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>scState<span class="token punctuation">{</span>
						addr<span class="token punctuation">:</span> resAddrs<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span>
						s<span class="token punctuation">:</span>    connectivity<span class="token punctuation">.</span>Idle<span class="token punctuation">,</span>
					<span class="token punctuation">}</span>
					bw<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					sc<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//  这一步真正做了连接的操作。</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> del <span class="token punctuation">{</span>
				bw<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">RemoveSubConn</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h2 id="_1-35"><a href="#_1-35" class="header-anchor">#</a> 1.35</h2> <h3 id="基于-grpc-的服务注册与发现和负载均衡的原理与实战"><a href="#基于-grpc-的服务注册与发现和负载均衡的原理与实战" class="header-anchor">#</a> 基于 gRPC 的服务注册与发现和负载均衡的原理与实战</h3> <p><a href="https://blog.csdn.net/ra681t58cjxsgckj31/article/details/110675344" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/ra681t58cjxsgckj31/article/details/110675344<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="resolver"><a href="#resolver" class="header-anchor">#</a> resolver</h3> <p>当我们的服务刚刚成型时，可能一个服务只有一台实例，这时候client要建立grpc连接很简单，只需要指定server的ip就可以了。但是，当服务成熟了，业务量大了，这个时候，一个实例就就不够用了，我们需要部署一个服务集群。一个集群有很多实例，且可以随时的扩容，部分实例出现了故障也没关系，这样就提升了服务的处理能力和稳定性，但是也带来一个问题，grpc的client，如何和这个集群里的server建立连接？</p> <p>这个问题可以一分为二，第一个问题：如何根据服务名称，返回实例的ip？这个问题有很多种解决方案，我们可以使用一些成熟的服务发现组件，例如consul或者zookeeper，也可以我们自己实现一个解析服务器；第二个问题，如何将我们选择的服务解析方式应用到grpc的连接建立中去？这个也不难，因为grpc的resolver，就是帮我们解决这个问题的，本篇，我们就来探讨一下，grpc的resolver是如何工作的，以及我们如何在项目中，使用resolver实现服务名称的解析。</p> <h4 id="resolver的工作原理"><a href="#resolver的工作原理" class="header-anchor">#</a> resolver的工作原理</h4> <p>关于resolver，我们主要有两个问题：</p> <ul><li><p>程序启动时，客户端是如何从一个域名/服务名，获取到其对应的实例ip，然后与之建立连接的呢？</p></li> <li><p>运行过程中，如果后端的实例挂了，grpc如何感知到，并重新建立连接呢？</p></li></ul> <p>接下来，我们就深入源码，搞清楚这两个问题。</p> <h4 id="启动时的解析过程"><a href="#启动时的解析过程" class="header-anchor">#</a> 启动时的解析过程</h4> <p>我们在使用grpc的时候，首先要做的就是调用Dial或DialContext函数来初始化一个clientConn对象，而resolver是这个连接对象的一个重要的成员，所以我们首先看一看clientConn对象创建过程中，resolver是怎么设置进去的。</p> <p>客户端启动时，一定会调用grpc的Dial或DialContext函数来创建连接，而这两个函数都需要传入一个名为target的参数，target，就是连接的目标，也就是server了，接下来，我们就看一看，DialContext函数里是如何处理这个target的。</p> <p>首先，创建了一个clientConn对象，并把target赋给了对象中的target：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>	cc <span class="token operator">:=</span> <span class="token operator">&amp;</span>ClientConn<span class="token punctuation">{</span>
		target<span class="token punctuation">:</span>            target<span class="token punctuation">,</span>
		csMgr<span class="token punctuation">:</span>             <span class="token operator">&amp;</span>connectivityStateManager<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		conns<span class="token punctuation">:</span>             <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token operator">*</span>addrConn<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		dopts<span class="token punctuation">:</span>             <span class="token function">defaultDialOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockingpicker<span class="token punctuation">:</span>    <span class="token function">newPickerWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		czData<span class="token punctuation">:</span>            <span class="token function">new</span><span class="token punctuation">(</span>channelzData<span class="token punctuation">)</span><span class="token punctuation">,</span>
		firstResolveEvent<span class="token punctuation">:</span> grpcsync<span class="token punctuation">.</span><span class="token function">NewEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来，对这个target进行解析</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>cc<span class="token punctuation">.</span>parsedTarget <span class="token operator">=</span> grpcutil<span class="token punctuation">.</span><span class="token function">ParseTarget</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以看看ParseTarget这个函数做了些什么：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// ParseTarget splits target into a resolver.Target struct containing scheme,</span>
<span class="token comment">// authority and endpoint.</span>
<span class="token comment">//</span>
<span class="token comment">// If target is not a valid scheme://authority/endpoint, it returns {Endpoint:</span>
<span class="token comment">// target}.</span>
<span class="token keyword">func</span> <span class="token function">ParseTarget</span><span class="token punctuation">(</span>target <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ret resolver<span class="token punctuation">.</span>Target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
	ret<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> ret<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span> ok <span class="token operator">=</span> <span class="token function">split2</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&quot;://&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> resolver<span class="token punctuation">.</span>Target<span class="token punctuation">{</span>Endpoint<span class="token punctuation">:</span> target<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	ret<span class="token punctuation">.</span>Authority<span class="token punctuation">,</span> ret<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span> ok <span class="token operator">=</span> <span class="token function">split2</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> resolver<span class="token punctuation">.</span>Target<span class="token punctuation">{</span>Endpoint<span class="token punctuation">:</span> target<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以看到，这个函数对target这个string进行了拆分，&quot;😕/&quot;前面的是scheme，也就是解析方案，后面的又可以分为authority和endpoint，endpoint比较好理解，就是对端，也就是server的一个标识，authority的话，我们的项目中并没有用，我也并不能完全理解，所以这里贴上<a href="https://github.com/grpc/grpc/blob/master/doc/naming.md" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>给出的一行解释，大家自行体会去吧。。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>authority indicates the DNS server to use<span class="token punctuation">,</span> although this is only supported by some implementations<span class="token punctuation">.</span> <span class="token punctuation">(</span>In C<span class="token operator">-</span>core<span class="token punctuation">,</span> the <span class="token keyword">default</span> DNS resolver does not support this<span class="token punctuation">,</span> but the c<span class="token operator">-</span>ares based resolver supports specifying this in the form <span class="token string">&quot;IP:port&quot;</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么解析出来的scheme有什么用呢？不要急，我们回到DialContext函数，接着往下看：</p> <p>解析完target之后执行的是下面这一句：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>resolverBuilder <span class="token operator">:=</span> cc<span class="token punctuation">.</span><span class="token function">getResolver</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是在根据解析的结果，包括scheme和endpoint这两个参数，获取一个resolver的builder，我们来看看获取的逻辑是怎么样的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cc <span class="token operator">*</span>ClientConn<span class="token punctuation">)</span> <span class="token function">getResolver</span><span class="token punctuation">(</span>scheme <span class="token builtin">string</span><span class="token punctuation">)</span> resolver<span class="token punctuation">.</span>Builder <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> rb <span class="token operator">:=</span> <span class="token keyword">range</span> cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>resolvers <span class="token punctuation">{</span>
		<span class="token keyword">if</span> scheme <span class="token operator">==</span> rb<span class="token punctuation">.</span><span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> rb
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> resolver<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里呢，其实就是在根据scheme进行查找，如果resolver已经在调用DialContext的时候通过opts参数传了进来，那我们就直接用，否则调用resolver.Get(scheme)去找，我们项目中就是用的resolver.Get(scheme)，所以我们再来看看这里是怎么做的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Get returns the resolver builder registered with the given scheme.</span>
<span class="token comment">//</span>
<span class="token comment">// If no builder is register with the scheme, nil will be returned.</span>
<span class="token keyword">func</span> <span class="token function">Get</span><span class="token punctuation">(</span>scheme <span class="token builtin">string</span><span class="token punctuation">)</span> Builder <span class="token punctuation">{</span>
	<span class="token keyword">if</span> b<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span>scheme<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里面，Get函数是通过m这个map，去查找有没有scheme对应的resolver的builder，那么m这个map是什么时候插入的值呢？这个在resolver的Register函数里：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Register</span><span class="token punctuation">(</span>b Builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m<span class="token punctuation">[</span>b<span class="token punctuation">.</span><span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> b
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>那么谁会去调用这个Register函数，向map中写入resolver呢？有两个人会去调，首先，grpc实现了一个默认的解析器，也就是&quot;passthrough&quot;，这个看名字就理解了，就是透传，所谓透传就是，什么都不做，那么什么时候需要透传呢？当你调用DialContext的时候，如果传入的target本身就是一个ip+port，这个时候，自然就不需要再解析什么了。那么&quot;passthrough&quot;对应的这个默认的解析器是什么时候注册到m这个map中的呢？这个调用在passthrough包的init函数里</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	resolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>passthroughBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而grpc包会import这个_ &quot;<a href="http://google.golang.org/grpc/internal/resolver/passthrough%22%E5%8C%85%EF%BC%8C%E6%89%80%E4%BB%A5%EF%BC%8C%22passthrough" target="_blank" rel="noopener noreferrer">google.golang.org/grpc/internal/resolver/passthrough&quot;包，所以，&quot;passthrough<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&quot;这个解析器在grpc初始化的时候就会被注册到m这个map中。</p> <p>回到谁会去调用这个Register函数这个问题，事实上，服务名称的解析会根据我们项目使用的命名系统的不同，而存在多种不同的方案，如果我们是使用consul实现服务发现，那么我们就希望我们的解析器实现的是通过concul客户端获取服务信息，而如果我们用的是dns服务，那么我们的解析器就应该通过我们的dns服务器去获取指定域名对应的服务器ip，总而言之，实现服务名称解析的方式太多了，所以grpc无法为我们一一实现，因此，需要我们自己根据自己使用的命名系统，去实现可以满足我们项目需求的resolver，然后将其Register到m这个map中来，这个就涉及到resolver的具体用法了，我们下一节再详细讲，这里先记住，Register这个函数，是需要我们自己实现完resolver去调用的。</p> <p>再回到DialContext这个函数，在通过getResolver获取resolver的builder之后，如果结果为nil，也就是没找到，会怎么样呢？</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>	resolverBuilder <span class="token operator">:=</span> cc<span class="token punctuation">.</span><span class="token function">getResolver</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
	<span class="token keyword">if</span> resolverBuilder <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// If resolver builder is still nil, the parsed target's scheme is</span>
		<span class="token comment">// not registered. Fallback to default resolver and set Endpoint to</span>
		<span class="token comment">// the original target.</span>
		channelz<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>channelzID<span class="token punctuation">,</span> <span class="token string">&quot;scheme %q not registered, fallback to default scheme&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
		cc<span class="token punctuation">.</span>parsedTarget <span class="token operator">=</span> resolver<span class="token punctuation">.</span>Target<span class="token punctuation">{</span>
			Scheme<span class="token punctuation">:</span>   resolver<span class="token punctuation">.</span><span class="token function">GetDefaultScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			Endpoint<span class="token punctuation">:</span> target<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		resolverBuilder <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">getResolver</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
		<span class="token keyword">if</span> resolverBuilder <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;could not get resolver for default scheme: %q&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到，scheme会被设置为默认的scheme，这个默认的scheme又是啥呢？</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>defaultScheme <span class="token operator">=</span> <span class="token string">&quot;passthrough&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>是的，就是这个passthrough，也就是说，没有获取到对应的resolver的时候，我们就认为是直接传了ip+port进来，就不去解析就好了。</p> <p>接下来，DialContext函数会使用获取到的resolver的builder，构建一个resolver，并将其赋给cc这个对象：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>    <span class="token comment">// Build the resolver.</span>
	rWrapper<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newCCResolverWrapper</span><span class="token punctuation">(</span>cc<span class="token punctuation">,</span> resolverBuilder<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to build resolver: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	cc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cc<span class="token punctuation">.</span>resolverWrapper <span class="token operator">=</span> rWrapper
	cc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>而使用builder构建resolver的时候又做了什么呢？我们再来看看newCCResolverWrapper函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// newCCResolverWrapper uses the resolver.Builder to build a Resolver and</span>
<span class="token comment">// returns a ccResolverWrapper object which wraps the newly built resolver.</span>
<span class="token keyword">func</span> <span class="token function">newCCResolverWrapper</span><span class="token punctuation">(</span>cc <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> rb resolver<span class="token punctuation">.</span>Builder<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ccResolverWrapper<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ccr <span class="token operator">:=</span> <span class="token operator">&amp;</span>ccResolverWrapper<span class="token punctuation">{</span>
		cc<span class="token punctuation">:</span>   cc<span class="token punctuation">,</span>
		done<span class="token punctuation">:</span> grpcsync<span class="token punctuation">.</span><span class="token function">NewEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">var</span> credsClone credentials<span class="token punctuation">.</span>TransportCredentials
	<span class="token keyword">if</span> creds <span class="token operator">:=</span> cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>copts<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">;</span> creds <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		credsClone <span class="token operator">=</span> creds<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	rbo <span class="token operator">:=</span> resolver<span class="token punctuation">.</span>BuildOptions<span class="token punctuation">{</span>
		DisableServiceConfig<span class="token punctuation">:</span> cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>disableServiceConfig<span class="token punctuation">,</span>
		DialCreds<span class="token punctuation">:</span>            credsClone<span class="token punctuation">,</span>
		CredsBundle<span class="token punctuation">:</span>          cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>copts<span class="token punctuation">.</span>CredsBundle<span class="token punctuation">,</span>
		Dialer<span class="token punctuation">:</span>               cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>copts<span class="token punctuation">.</span>Dialer<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token comment">// We need to hold the lock here while we assign to the ccr.resolver field</span>
	<span class="token comment">// to guard against a data race caused by the following code path,</span>
	<span class="token comment">// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up</span>
	<span class="token comment">// accessing ccr.resolver which is being assigned here.</span>
	ccr<span class="token punctuation">.</span>resolverMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ccr<span class="token punctuation">.</span>resolverMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ccr<span class="token punctuation">.</span>resolver<span class="token punctuation">,</span> err <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">,</span> ccr<span class="token punctuation">,</span> rbo<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ccr<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这个函数最重要的一行，就是调用了我们传入的builder的Build方法，也就是这一行：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ccr<span class="token punctuation">.</span>resolver<span class="token punctuation">,</span> err <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">,</span> ccr<span class="token punctuation">,</span> rbo<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上面说过了，我们用的resolver还有resolver对应的builder都是需要我们自己实现的，所以Build方法里做了什么，这就要看你想让他做什么了，那么我们一般要在Build里完成哪些工作呢，这个我们下一节再探讨。</p> <p>到这里，DialContext函数中关于resolver的部分我们就看完了，也知道了ClientConn对象的resolver是如何设置进去的，但是Dial函数只是创建了一个抽象的连接，实际的http2连接并没有在这里创建，所以我们接下来要探讨的就是，实际创建http2连接的时候，是如何利用resolver，获取到服务对应的ip的。</p> <p>底层http2连接对应的是一个grpc的stream，而stream的创建有两种方式，一种就是我们主动去创建一个stream池，这样当有请求需要发送时，我们可以直接使用我们创建好的stream，关于stream池的用法，内容较多，本篇就先不探讨了，以后我会单独写一篇。除了我们自己创建，我们使用protoc为我们生成的客户端接口里，也会为我们实现stream的创建，也就是说这个完全是可以不用我们自己费心的，我们随便看一个protoc生成的客户端接口：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>greeterClient<span class="token punctuation">)</span> <span class="token function">SayHello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>HelloRequest<span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>HelloReply<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>HelloReply<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;/helloworld.Greeter/SayHello&quot;</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> out<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里，请求是通过Invoke函数发出的，所以接着看Invoke：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cc <span class="token operator">*</span>ClientConn<span class="token punctuation">)</span> <span class="token function">Invoke</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// allow interceptor to see all applicable call options, which means those</span>
	<span class="token comment">// configured as defaults from dial option as well as per-call options</span>
	opts <span class="token operator">=</span> <span class="token function">combine</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>callOptions<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
 
	<span class="token keyword">if</span> cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span>unaryInt <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> cc<span class="token punctuation">.</span>dopts<span class="token punctuation">.</span><span class="token function">unaryInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> invoke<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">invoke</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在没有设置拦截器的情况下，会直接调invoke：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">invoke</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method <span class="token builtin">string</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> opts <span class="token operator">...</span>CallOption<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	cs<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newClientStream</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> unaryStreamDesc<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> method<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> cs<span class="token punctuation">.</span><span class="token function">SendMsg</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> cs<span class="token punctuation">.</span><span class="token function">RecvMsg</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里我们看到，发送请求之前，会先创建一个stream，我们看看创建过程中的调用过程：</p> <ul><li>newClientStream</li> <li>newAttemptLocked</li> <li>getTransport</li> <li>pick</li> <li>getReadyTransport</li> <li>connect</li> <li>resetTransport</li> <li>tryAllAddrs</li> <li>createTransport</li> <li>NewClientTransport</li> <li>newHTTP2Client</li></ul> <p>这个过程看着还是挺长的，所以没有逐一的去贴代码，注意到最后，调用了newHTTP2Client，这就是我们想找的创建http2连接的地方了，再往底层我们就暂且不看了。</p> <h4 id="运行过程中的更新过程"><a href="#运行过程中的更新过程" class="header-anchor">#</a> 运行过程中的更新过程</h4> <p>这一小节要搞明白的就是第二个问题：后端的实例挂了，client如何感知，并创建新的连接呢？</p> <p>这要从上一小节最后给到到创建stream的调用过程继续说起，注意到，调用过程中，有一个函数是resetTransport，我们来看看这个函数的实现。</p> <p>首先，这一段实现了连接的创建：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>newTr<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> reconnect<span class="token punctuation">,</span> err <span class="token operator">:=</span> ac<span class="token punctuation">.</span><span class="token function">tryAllAddrs</span><span class="token punctuation">(</span>addrs<span class="token punctuation">,</span> connectDeadline<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// After exhausting all addresses, the addrConn enters</span>
			<span class="token comment">// TRANSIENT_FAILURE.</span>
			ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> ac<span class="token punctuation">.</span>state <span class="token operator">==</span> connectivity<span class="token punctuation">.</span>Shutdown <span class="token punctuation">{</span>
				ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			ac<span class="token punctuation">.</span><span class="token function">updateConnectivityState</span><span class="token punctuation">(</span>connectivity<span class="token punctuation">.</span>TransientFailure<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
 
			<span class="token comment">// Backoff.</span>
			b <span class="token operator">:=</span> ac<span class="token punctuation">.</span>resetBackoff
			ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
			timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>backoffFor<span class="token punctuation">)</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>timer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
				ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				ac<span class="token punctuation">.</span>backoffIdx<span class="token operator">++</span>
				ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>b<span class="token punctuation">:</span>
				timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ac<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>这里调用的tryAllAddrs函数很好理解，就是把resolver解析结果中的addr全试一遍，知道和其中一个addr成功建立连接，如果失败，会等待一个退避时间，然后重试，需要注意的是，重试的时候，要经过resetTransport函数最开头的这段：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			ac<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">resolveNow</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>ResolveNowOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是说，如果不是第一次创建连接，就要调用clientConn的resolveNow方法，重新获取一次解析的结果，这很重要，因为创建连接失败的原因很有可能就是上一次解析的结果对应的实例已经挂了。</p> <p>上面说的是如果第一次连接就建立失败的情况，这种其实不太常见，常见的是连接建立之后，后端的服务因为网络故障或者升级之类的原因导致的连接断开，这种情况下grpc是如何发现的呢？要搞明白这个，就要看下tryAllAddrs函数里面调用的createTransport函数的内容了：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>onGoAway <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>r transport<span class="token punctuation">.</span>GoAwayReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		ac<span class="token punctuation">.</span><span class="token function">adjustParams</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> ac<span class="token punctuation">.</span>state <span class="token operator">==</span> connectivity<span class="token punctuation">.</span>Ready <span class="token punctuation">{</span>
				<span class="token comment">// Prevent this SubConn from being used for new RPCs by setting its</span>
				<span class="token comment">// state to Connecting.</span>
				<span class="token comment">//</span>
				<span class="token comment">// TODO: this should be Idle when grpc-go properly supports it.</span>
				ac<span class="token punctuation">.</span><span class="token function">updateConnectivityState</span><span class="token punctuation">(</span>connectivity<span class="token punctuation">.</span>Connecting<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		reconnect<span class="token punctuation">.</span><span class="token function">Fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
onClose <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> ac<span class="token punctuation">.</span>state <span class="token operator">==</span> connectivity<span class="token punctuation">.</span>Ready <span class="token punctuation">{</span>
				<span class="token comment">// Prevent this SubConn from being used for new RPCs by setting its</span>
				<span class="token comment">// state to Connecting.</span>
				<span class="token comment">//</span>
				<span class="token comment">// TODO: this should be Idle when grpc-go properly supports it.</span>
				ac<span class="token punctuation">.</span><span class="token function">updateConnectivityState</span><span class="token punctuation">(</span>connectivity<span class="token punctuation">.</span>Connecting<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		ac<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>onCloseCalled<span class="token punctuation">)</span>
		reconnect<span class="token punctuation">.</span><span class="token function">Fire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>上面这两段，定义了连接goAway或者close的时候，该怎么处理，这两个函数会作为参数传入transport.NewClientTransport函数，进而设置到后面通过newHTTP2Client创建的http2client对象中，那么这两个函数何时会被触发呢？</p> <p>以onGoAway函数为例，我们可以看看http2client的reader方法：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>http2Client<span class="token punctuation">)</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>readerDone<span class="token punctuation">)</span>
	<span class="token comment">// Check the validity of server preface.</span>
	frame<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span>framer<span class="token punctuation">.</span>fr<span class="token punctuation">.</span><span class="token function">ReadFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this kicks off resetTransport, so must be last before return</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">SetReadDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// reset deadline once we get the settings frame (we didn't time out, yay!)</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>keepaliveEnabled <span class="token punctuation">{</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>lastRead<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	sf<span class="token punctuation">,</span> ok <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>http2<span class="token punctuation">.</span>SettingsFrame<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this kicks off resetTransport, so must be last before return</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">onPrefaceReceipt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">handleSettings</span><span class="token punctuation">(</span>sf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 
	<span class="token comment">// loop to keep reading incoming messages on this transport.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span>controlBuf<span class="token punctuation">.</span><span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		frame<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span>framer<span class="token punctuation">.</span>fr<span class="token punctuation">.</span><span class="token function">ReadFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>keepaliveEnabled <span class="token punctuation">{</span>
			atomic<span class="token punctuation">.</span><span class="token function">StoreInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">.</span>lastRead<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// Abort an active stream if the http2.Framer returns a</span>
			<span class="token comment">// http2.StreamError. This can happen only if the server's response</span>
			<span class="token comment">// is malformed http2.</span>
			<span class="token keyword">if</span> se<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>http2<span class="token punctuation">.</span>StreamError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				t<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				s <span class="token operator">:=</span> t<span class="token punctuation">.</span>activeStreams<span class="token punctuation">[</span>se<span class="token punctuation">.</span>StreamID<span class="token punctuation">]</span>
				t<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token comment">// use error detail to provide better err message</span>
					code <span class="token operator">:=</span> http2ErrConvTab<span class="token punctuation">[</span>se<span class="token punctuation">.</span>Code<span class="token punctuation">]</span>
					msg <span class="token operator">:=</span> t<span class="token punctuation">.</span>framer<span class="token punctuation">.</span>fr<span class="token punctuation">.</span><span class="token function">ErrorDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					t<span class="token punctuation">.</span><span class="token function">closeStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> http2<span class="token punctuation">.</span>ErrCodeProtocol<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// Transport error.</span>
				t<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">switch</span> frame <span class="token operator">:=</span> frame<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>MetaHeadersFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">operateHeaders</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>DataFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handleData</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>RSTStreamFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handleRSTStream</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>SettingsFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handleSettings</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>PingFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handlePing</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>GoAwayFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handleGoAway</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>http2<span class="token punctuation">.</span>WindowUpdateFrame<span class="token punctuation">:</span>
			t<span class="token punctuation">.</span><span class="token function">handleWindowUpdate</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">errorf</span><span class="token punctuation">(</span><span class="token string">&quot;transport: http2Client.reader got unhandled frame type %v.&quot;</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>可以看到，reader方法会读取连接上的所有消息，如果是GoAway类型，则会调用上面我们设置的onGoAway，而onGoAway函数里的reconnect.Fire()，会触发reconnect这个事件，这个事件被触发会怎么样呢？我们再回到resetTransport函数，这个函数在连接成功创建之后，会阻塞在这里：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Block until the created transport is down. And when this happens,</span>
		<span class="token comment">// we restart from the top of the addr list.</span>
		<span class="token operator">&lt;-</span>reconnect<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是说，函数在等这个连接goAway或者close，当这两种情况发生时，程序就会接着走，也就是进入下一次循环，就会重新获取resolver的结果，然后建立连接，这样就说通了，我们再来捋一下：</p> <ul><li>首先，已经连接的后端发生了故障；</li> <li>然后，已经建立的http2client读到了连接goAway；</li> <li>再然后，resetTransport进入一次新的循环，重新获取解析结果；</li> <li>最后，resetTransport里通过新获取到的地址，重新建立连接</li></ul> <p>到这里，我们就搞清楚了，grpc是如何保证连接一直是可用的了。</p> <h4 id="resolver的使用"><a href="#resolver的使用" class="header-anchor">#</a> resolver的使用</h4> <p>明白了大致原理，我们再来看看如何使用，其实最关键的一点在上面已经说过了，就是我们自己实现满足我们自己业务要求的resolver，这里我就系统的举一个例子吧。</p> <p>假设，我们后端的每一个服务都对应了一个域名，比如订单服务是service.order，支付服务是service.payment，然后我们自己的域名解析系统提供一个web api，url是http://myself.dns.xyz，当你想获取订单服务对应的实例的ip+port时，只需要发送一条：</p> <p>GET <a href="http://myself.dns.xyz?service=service.order" target="_blank" rel="noopener noreferrer">http://myself.dns.xyz?service=service.order<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>欧克，接下来我们来实现这个解析器。</p> <p>首先，我们创建一个单独的包，就叫mydns吧，注意在这个包里，我们要实现两个东西，一个是resolver，一个是resolver的builder</p> <p>我们先来实现resolver：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mydnsResolver <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	domain       <span class="token builtin">string</span>
	port         <span class="token builtin">string</span>
	address      <span class="token keyword">map</span><span class="token punctuation">[</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	ctx    context<span class="token punctuation">.</span>Context
	cancel context<span class="token punctuation">.</span>CancelFunc
	cc     resolver<span class="token punctuation">.</span>ClientConn
	wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token punctuation">}</span>
 
<span class="token comment">// ResolveNow resolves immediately</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mr <span class="token operator">*</span>mydnsResolver<span class="token punctuation">)</span> <span class="token function">ResolveNow</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>ResolveNowOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> mr<span class="token punctuation">.</span>rn <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// Close stops resolving</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mr <span class="token operator">*</span>mydnsResolver<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mr<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mr<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token punctuation">(</span>mr <span class="token operator">*</span>mydnsResolver<span class="token punctuation">)</span> <span class="token function">watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> util<span class="token punctuation">.</span><span class="token function">CheckPanic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mr<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>mr<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>mr<span class="token punctuation">.</span>rn<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
		result<span class="token punctuation">,</span> err <span class="token operator">:=</span> mr<span class="token punctuation">.</span><span class="token function">resolveByHttpDNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		mr<span class="token punctuation">.</span>cc<span class="token punctuation">.</span><span class="token function">UpdateState</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>State<span class="token punctuation">{</span>Addresses<span class="token punctuation">:</span> result<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token punctuation">(</span>mr <span class="token operator">*</span>mydnsResolver<span class="token punctuation">)</span> <span class="token function">resolveByHttpDNS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> items <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
 
	<span class="token comment">//这里实现通过向http://myself.dns.xyz发送get请求获取实例ip列表，并存入items中</span>
 
	<span class="token keyword">var</span> addresses <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
		addr <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">JoinHostPort</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> mr<span class="token punctuation">.</span>port<span class="token punctuation">)</span>
		a <span class="token operator">:=</span> resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>
			Addr<span class="token punctuation">:</span>       addr<span class="token punctuation">,</span>
			ServerName<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> <span class="token comment">// same as addr</span>
			Type<span class="token punctuation">:</span>       resolver<span class="token punctuation">.</span>Backend<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		addresses <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>addresses<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">return</span> addresses<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>再来实现builder：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mydnsBuilder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> resolver<span class="token punctuation">.</span>Builder <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>mydnsBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// Scheme for mydns</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mb <span class="token operator">*</span>mydnsBuilder<span class="token punctuation">)</span> <span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;mydns&quot;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// Build</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mb <span class="token operator">*</span>mydnsBuilder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span>target resolver<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> cc resolver<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> <span class="token boolean">_</span> resolver<span class="token punctuation">.</span>BuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>Resolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Endpoint<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		host <span class="token operator">=</span> target<span class="token punctuation">.</span>Endpoint
		port <span class="token operator">=</span> <span class="token string">&quot;80&quot;</span>
	<span class="token punctuation">}</span>
 
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	mr <span class="token operator">:=</span> <span class="token operator">&amp;</span>mydnsResolver<span class="token punctuation">{</span>
		domain<span class="token punctuation">:</span>       host<span class="token punctuation">,</span>
		port<span class="token punctuation">:</span>         port<span class="token punctuation">,</span>
		cc<span class="token punctuation">:</span>           cc<span class="token punctuation">,</span>
		rn<span class="token punctuation">:</span>           <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		address<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>resolver<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	mr<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> pr<span class="token punctuation">.</span>cancel <span class="token operator">=</span> ctx<span class="token punctuation">,</span> cancel
 
	mr<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> mr<span class="token punctuation">.</span><span class="token function">watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	mr<span class="token punctuation">.</span><span class="token function">ResolveNow</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>ResolveNowOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> mr<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>接下来我们还要实现，当这个包初始化时，将scheme注册到grpc的解析器map中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	resolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token function">NewBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>实现好这个包之后，我们只需要在调用Dial的文件import mydns这个包，并且保证传入的target满足以下格式：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>mydns<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>service<span class="token punctuation">.</span>order
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>grpc就会使用我们实现的解析器，向我们自己的dns服务器请求服务对应的ip地址了，就是这么简单～</p> <p>Reference:<a href="https://blog.csdn.net/u013536232/article/details/108556544" target="_blank" rel="noopener noreferrer">grpc进阶篇之resolver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/u013536232/article/details/108308504" target="_blank" rel="noopener noreferrer">grpc进阶篇之retry拦截器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/2/2021, 3:11:05 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc/redis.html" class="prev">
        Redis
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b7ea3b73.js" defer></script><script src="/assets/js/2.6b359cc1.js" defer></script><script src="/assets/js/21.c8782d58.js" defer></script>
  </body>
</html>
